# CS143_PA5-Cool_Code-Generator
1.概述
代码生成器(Code Generator)是编译器后端的核心组件，负责将经过语义分析的抽象语法树（AST）转换为可在 SPIM 模拟器上运行的 MIPS 汇编代码。实现严格遵循 COOL 运行时模型，包括对象内存布局、分发表（dispatch table）机制、垃圾回收支持以及表达式求值约定。

本repo只提供了/assignments/PA5目录下的代码文件，需要完整环境需前往官网自行下载安装。

测试方法：
1.安装完毕完整环境后，将此文件夹内全部文件覆盖复制至同名目录下。并移动到该目录下。
2.make clean && make cgen
3.使用~/cool/tests/ 目录下的官方测试用例进行编译测试，例如./mycoolc good.cl，代码生成器会自动生成.s文件。

2.设计思路
代码生成器的设计采用自顶向下、递归下降的策略，将整个程序的生成过程分解为多个清晰的阶段：
全局数据初始化：生成 .data 段，包含所有字符串、整数、布尔常量，以及类名表、对象原型表和分发表。
常量池构建：为程序中出现的所有字面量（字符串、整数、布尔值）在内存中分配唯一的标签和空间。
类结构代码生成：为每个类生成其原型对象（prototype object）和初始化方法（init method）。
方法体代码生成：遍历每个类的方法，递归地为其 AST 生成对应的 MIPS 指令序列。
主程序入口：生成 _main 函数，作为程序执行的起点。
整个过程由 CgenClassTable::code() 方法驱动，确保了生成的汇编代码结构清晰、符合规范。
核心数据结构
Environment：代码生成时的上下文环境。它通过符号表精确跟踪变量、方法参数和类属性在栈帧或对象中的位置（偏移量）。这对于正确生成 lw/sw 指令至关重要。
CgenClassTable：管理所有类的代码生成。它负责协调常量生成、类表构建、分发表创建和方法代码发射。
CgenNode：代表一个类的代码生成节点。它封装了该类的继承链、完整的属性列表（包括从父类继承的）和方法列表，并提供获取属性偏移量等关键信息的接口。
关键算法实现

2.1 表达式代码生成模式
所有表达式的代码生成遵循统一的模式，其结果始终存放在 $a0 (ACC) 寄存器中。
算法逻辑：
递归处理子表达式：对当前表达式的每个子节点调用其 code() 方法。
保存中间结果：如果后续操作需要使用之前子表达式的结果，需先将其压入栈（$sp）保存。
执行操作：根据表达式类型（如算术运算、比较、赋值等）生成相应的 MIPS 指令。
恢复中间结果：从栈中弹出之前保存的值到临时寄存器（如 $t1）。
清理：确保栈指针 ($sp) 在操作前后保持平衡。

2.2 对象与方法调用
动态分派 (Dynamic Dispatch)：
首先计算对象表达式，其地址在 $a0 中。
从对象头中加载其分发表地址 (lw $t1, 8($a0))。
根据方法名在分发表中的固定偏移量，加载实际的方法入口地址 (lw $t1, offset($t1))。
使用 jalr $t1 跳转到该地址执行。
静态分派 (Static Dispatch)：
直接跳转到目标类的分发表中对应方法的地址，无需在运行时查询对象的实际类型。

2.3 内存布局与访问
对象内存布局（从低地址到高地址）：
-4: GC 标记 (Eye-catcher)
0: Class Tag (类标签)
4: Size (对象总大小，以字为单位)
8: Dispatch Table Pointer (分发表指针)
12+: Attributes (属性，按继承顺序排列)
属性访问：
属性 x 的偏移量 = (属性索引 + 3) * 4 字节。
加载：lw $a0, (idx+3)*4($s0) （$s0 指向 self）
存储：sw $a0, (idx+3)*4($s0)

2.4 常量生成
字符串常量：
在 .data 段中为每个唯一字符串分配一个标签（如 str_const0）。
其内存布局包含 GC 标记、类标签、大小、分发表指针、一个指向其长度（也是一个 Int 常量）的指针，以及实际的 ASCII 数据。

